

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/IMG_20240421_150811.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yaodeer">
  <meta name="keywords" content="">
  
    <meta name="description" content="本节负责实现身份验证和授权、用户注册、登陆登出、修改用户信息的功能">
<meta property="og:type" content="article">
<meta property="og:title" content="react课程22-实现较为完整的用户管理功能">
<meta property="og:url" content="http://example.com/2024/09/26/react%E8%AF%BE%E7%A8%8B22-%E5%AE%9E%E7%8E%B0%E8%BE%83%E4%B8%BA%E5%AE%8C%E6%95%B4%E7%9A%84%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD/index.html">
<meta property="og:site_name" content="Yaodeer">
<meta property="og:description" content="本节负责实现身份验证和授权、用户注册、登陆登出、修改用户信息的功能">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926145909054.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926153141752.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926172620751.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926192815075.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927091045026.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-09-27%20090706.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927092904298.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927093243940.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927093406787.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-09-27%20092114.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927093914593.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926224628775.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927100812071.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927100757718.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927101356754.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927105001683.png">
<meta property="article:published_time" content="2024-09-26T11:49:48.223Z">
<meta property="article:modified_time" content="2024-09-27T08:26:27.881Z">
<meta property="article:author" content="Yaodeer">
<meta property="article:tag" content="react">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926145909054.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>react课程22-实现较为完整的用户管理功能 - Yaodeer</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 85vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>姚姚</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/MVIMG_20231023_100821.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="react课程22-实现较为完整的用户管理功能"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-09-26 19:49" pubdate>
          September 26, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.5k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          38 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">react课程22-实现较为完整的用户管理功能</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    Last updated on September 27, 2024 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>本节负责实现身份验证和授权、用户注册、登陆登出、修改用户信息的功能</p>
<span id="more"></span>

<h3 id="一、身份验证和授权"><a href="#一、身份验证和授权" class="headerlink" title="一、身份验证和授权"></a>一、身份验证和授权</h3><h4 id="（1）-Authentication"><a href="#（1）-Authentication" class="headerlink" title="（1） Authentication"></a>（1） <strong>Authentication</strong></h4><blockquote>
<p>身份验证是确认用户的身份的过程，目的是验证用户是谁。</p>
</blockquote>
<p>首先我们在Authentication中新建了一个user，然后到API DOCS中的user management中寻找<code>Log in with Email/Password</code>这一段代码，copy下来放置进apiAuth中。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">&#123; email, password &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; data, error &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">signInWithPassword</span>(&#123;<br>    email,<br>    password,<br>  &#125;);<br><br>  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error.<span class="hljs-property">message</span>);<br><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br>  <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后可以新建一个useLogin钩子，得到mutation函数来处理登陆。可以看出onSuccess函数可以得到data，于是可以记录到控制台查看信息。</p>
<p>调用 <code>queryClient.setQueryData([&#39;user&#39;], user.user);</code>：将登录成功的用户数据缓存到 <code>[&#39;user&#39;]</code> 查询中，这样应用的其他部分可以使用这个用户信息。（user是object，包含session和user，而我们想要的只是user：用户）</p>
<p>replace是为了替换浏览记录。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useLogin</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> queryClient = <span class="hljs-title function_">useQueryClient</span>();<br>  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();<br><br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">mutate</span>: login, isLoading &#125; = <span class="hljs-title function_">useMutation</span>(&#123;<br>    <span class="hljs-attr">mutationFn</span>: <span class="hljs-function">(<span class="hljs-params">&#123; email, password &#125;</span>) =&gt;</span> <span class="hljs-title function_">loginApi</span>(&#123; email, password &#125;),<br>    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> &#123;<br>      queryClient.<span class="hljs-title function_">setQueryData</span>([<span class="hljs-string">&#x27;user&#x27;</span>], user.<span class="hljs-property">user</span>);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user);<br>      <span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>，&#123;<span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>&#125;);<br>    &#125;,<br>    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);<br>      toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Provided email or password are incorrect&#x27;</span>);<br>    &#125;,<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> &#123; login, isLoading &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 <code>supabase.auth.signInWithPassword(&#123; email, password &#125;)</code> 时，<code>Supabase</code> 会将你提供的 <code>email</code> 和 <code>password</code> 发送到它的身份验证服务。</p>
<p><code>Supabase</code> 在后台会将提供的 <code>email</code> 和 <code>password</code> 与其数据库中存储的用户信息进行比较。验证流程包括：</p>
<ul>
<li><strong>查找用户</strong>：<code>Supabase</code> 会在其用户数据库中根据提供的 <code>email</code> 查找相应的用户记录。</li>
<li><strong>验证密码</strong>：找到用户后，<code>Supabase</code> 会对传入的 <code>password</code> 进行加密（通常是哈希处理），然后与数据库中存储的哈希值进行比较。密码在存储时是经过哈希加密的，数据库不直接存储明文密码。</li>
</ul>
<p>验证结果：</p>
<ul>
<li><strong>成功</strong>：如果邮箱存在且密码匹配，<code>Supabase</code> 会返回一个包含用户数据的响应（即 <code>data</code> 对象）。这表示用户身份验证成功，用户可以登录。</li>
<li><strong>失败</strong>：如果邮箱不存在或者密码不正确，<code>Supabase</code> 会返回一个 <code>error</code> 对象，其中包含错误信息（例如 “Invalid login credentials”）。</li>
</ul>
<p>我们会发现登陆成功后，在浏览器storage出现了token。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926145909054.png" srcset="/img/loading.gif" lazyload alt="image-20240926145909054"></p>
<h4 id="（2）Authorization"><a href="#（2）Authorization" class="headerlink" title="（2）Authorization"></a>（2）Authorization</h4><blockquote>
<p>授权是在身份验证成功后，确定用户对系统资源或操作的访问权限的过程。</p>
</blockquote>
<p>建立一个<code>ProtectedRout</code>组件，并在<code>App.jsx</code>的Route中把<code>Applayout</code>组件用它包裹起来。由于其他界面都在<code>Applayout</code>中被渲染，所以用户必须通过身份验证，才能进入任何在 <code>AppLayout</code> 中渲染的页面。（代码简洁，性能优化，更好的维护性）</p>
<p><code>ProtectedRoute</code> 是一个自定义的路由组件，主要职责是限制对某些路由的访问，用来保护一组路由，通常是检查用户是否登录或是否有访问权限。</p>
<h5 id="1、从supabase中获取用户的信息"><a href="#1、从supabase中获取用户的信息" class="headerlink" title="1、从supabase中获取用户的信息"></a>1、从supabase中获取用户的信息</h5><blockquote>
<p><strong>会话</strong>（Session）是指在一段时间内，用户与系统之间的持续交互状态或连接。会话管理是现代应用程序和服务中的重要机制，用于跟踪用户的身份和状态。具体来说，会话与身份验证和授权密切相关。会话通常在用户登录或访问某个系统时开始，并在用户注销或超时后结束（详见文末）</p>
</blockquote>
<p>通过检查用户的当前会话，从本地内存中获取登录用户的信息。如果没有会话（即用户未登录），返回 <code>null</code>；如果会话有效，则获取并返回用户信息。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentUser</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: session &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getSession</span>();<br>  <span class="hljs-keyword">if</span> (!session.<span class="hljs-property">session</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-keyword">const</span> &#123; data, error &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getUser</span>();<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br><br>  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error.<span class="hljs-property">message</span>);<br><br>  <span class="hljs-keyword">return</span> data?.<span class="hljs-property">user</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2、useUser-js"><a href="#2、useUser-js" class="headerlink" title="2、useUser.js"></a>2、useUser.js</h5><p>获取当前用户并将其存储到缓存中，这样就不用每次都重新下载。（获取isAuthenticated）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUser</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; isLoading, <span class="hljs-attr">data</span>: user &#125; = <span class="hljs-title function_">useQuery</span>(&#123;<br>    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;user&#x27;</span>],<br>    <span class="hljs-attr">queryFn</span>: getCurrentUser,<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> &#123; isLoading, user, <span class="hljs-attr">isAuthenticated</span>: user?.<span class="hljs-property">role</span> === <span class="hljs-string">&#x27;authenticated&#x27;</span> &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下图为登陆后React Query工具里得到的信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926153141752.png" srcset="/img/loading.gif" lazyload alt="image-20240926153141752"></p>
<h5 id="3、在ProtectRouter中来验证是否需要重定向到login界面"><a href="#3、在ProtectRouter中来验证是否需要重定向到login界面" class="headerlink" title="3、在ProtectRouter中来验证是否需要重定向到login界面"></a>3、在ProtectRouter中来验证是否需要重定向到login界面</h5><blockquote>
<p><code>navigate</code> 并<strong>不限于</strong>回调函数或 <code>useEffect</code> 中使用，但这些场景是最常见和安全的使用方式</p>
<p>不推荐在组件首次渲染的时候使用navigate。详见Router专题</p>
</blockquote>
<ol>
<li>得到 <code>isAuthenticated</code> </li>
<li>如果没有登陆就重定向到login界面（<strong>注意是在加载完成后检验是否认证！！！</strong>）</li>
<li>如果还在加载就返回一个加载指示器</li>
<li>如果已经登陆就渲染App</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProtectedRoute</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();<br>  <span class="hljs-keyword">const</span> &#123; isLoading, isAuthenticated &#125; = <span class="hljs-title function_">useUser</span>();<br><br>  <span class="hljs-title function_">useEffect</span>(<br>    <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">if</span> (!isAuthenticated &amp;&amp; !isLoading) <span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/login&#x27;</span>);<br>    &#125;,<br>    [isAuthenticated, isLoading, navigate]<br>  );<br><br>  <span class="hljs-keyword">if</span> (isLoading)<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">FullPage</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">FullPage</span>&gt;</span></span><br>    );<br><br>  <span class="hljs-keyword">if</span> (isAuthenticated) <span class="hljs-keyword">return</span> children;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="（3）Log-out"><a href="#（3）Log-out" class="headerlink" title="（3）Log out"></a>（3）Log out</h4><h5 id="1、apiAuth"><a href="#1、apiAuth" class="headerlink" title="1、apiAuth"></a>1、apiAuth</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params">&#123; email, password &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; error &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">signOut</span>();<br><br>  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error.<span class="hljs-property">message</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="2、useLogout"><a href="#2、useLogout" class="headerlink" title="2、useLogout"></a>2、useLogout</h5><p><code>queryClient.removeQueries()</code>：清除 <code>react-query</code> 缓存中的所有数据，确保用户退出后，应用不再保留之前的查询数据。</p>
<p><code>navigate(&#39;/login&#39;, &#123; replace: true &#125;)</code>：将用户重定向到登录页面，并且使用 <code>replace: true</code> 替换当前的历史记录，这样用户在点击“返回”按钮时不会回到之前已登出的页面。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useLogout</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> queryClient = <span class="hljs-title function_">useQueryClient</span>();<br>  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();<br><br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">mutate</span>: logout, isLoading &#125; = <span class="hljs-title function_">useMutation</span>(&#123;<br>    <span class="hljs-attr">mutationFn</span>: logoutApi,<br>    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>      queryClient.<span class="hljs-title function_">removeQueries</span>();<br>      <span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, &#123; <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> &#125;);<br>    &#125;,<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> &#123; logout, isLoading &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="3、Logout组件"><a href="#3、Logout组件" class="headerlink" title="3、Logout组件"></a>3、Logout组件</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Logout</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; logout, isLoading &#125; = <span class="hljs-title function_">useLogout</span>();<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ButtonIcon</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isLoading&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;logout&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;!isLoading ? <span class="hljs-tag">&lt;<span class="hljs-name">HiArrowRightOnRectangle</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">SpinnerMini</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ButtonIcon</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="二、实现注册功能"><a href="#二、实现注册功能" class="headerlink" title="二、实现注册功能"></a>二、实现注册功能</h3><blockquote>
<p>在这个APP中，逻辑是只有登陆成功后才能注册其他用户。</p>
</blockquote>
<h4 id="（1）创建注册表单"><a href="#（1）创建注册表单" class="headerlink" title="（1）创建注册表单"></a>（1）创建注册表单</h4><h5 id="1、需要用到的工具"><a href="#1、需要用到的工具" class="headerlink" title="1、需要用到的工具"></a>1、需要用到的工具</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> &#123; register, formState, getValues, handleSubmit &#125; = <span class="hljs-title function_">useForm</span>();<br><span class="hljs-keyword">const</span> &#123; errors &#125; = formState;<br></code></pre></td></tr></table></figure>



<h5 id="2、验证信息"><a href="#2、验证信息" class="headerlink" title="2、验证信息"></a>2、验证信息</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&#123;...<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;fullName&#x27;</span>, &#123; <span class="hljs-attr">required</span>: <span class="hljs-string">&#x27;This field is required&#x27;</span> &#125;)&#125;<br><br>&#123;...<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;email&#x27;</span>, &#123;<br>   <span class="hljs-attr">required</span>: <span class="hljs-string">&#x27;This field is required&#x27;</span>,<br>      <span class="hljs-attr">pattern</span>: &#123;<br>      <span class="hljs-attr">value</span>: <span class="hljs-regexp">/\S+@\S+\.\S+/</span>,<br>      <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Please provide a valid email address&#x27;</span>,<br>   &#125;,<br>&#125;)&#125;<br><br>&#123;...<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;password&#x27;</span>, &#123;<br>   <span class="hljs-attr">required</span>: <span class="hljs-string">&#x27;This field is required&#x27;</span>,<br>   <span class="hljs-attr">minLength</span>: &#123;<br>   <span class="hljs-attr">value</span>: <span class="hljs-number">8</span>,<br>       <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Password needs a minimum of 8 characters&#x27;</span>,<br>   &#125;,<br>&#125;)&#125;<br><br>&#123;...<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;passwordConfirm&#x27;</span>, &#123;<br>   <span class="hljs-attr">required</span>: <span class="hljs-string">&#x27;This field is required&#x27;</span>,<br>   <span class="hljs-attr">validate</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span><br>       value === <span class="hljs-title function_">getValues</span>().<span class="hljs-property">password</span> || <span class="hljs-string">&#x27;Passwords need to match&#x27;</span>,<br>&#125;)&#125;<br></code></pre></td></tr></table></figure>



<h5 id="3、如何提交表单？错误如何展示"><a href="#3、如何提交表单？错误如何展示" class="headerlink" title="3、如何提交表单？错误如何展示?"></a>3、如何提交表单？错误如何展示?</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Form</span> onSubmit=&#123;<span class="hljs-title function_">handleSubmit</span>(onSubmit)&#125;&gt;<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">FormRow</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;Full name&quot;</span> <span class="hljs-attr">error</span>=<span class="hljs-string">&#123;errors?.fullName?.message&#125;</span>&gt;</span>  &#123;/以此类推/&#125;</span><br></code></pre></td></tr></table></figure>



<h4 id="（2）实现把用户注册到supabase"><a href="#（2）实现把用户注册到supabase" class="headerlink" title="（2）实现把用户注册到supabase"></a>（2）实现把用户注册到supabase</h4><p>伤到了，谁懂，supabase界面全英文，看到有一个警告，但是看不懂也没当回事，但是验证创建user的时候就出问题了。原来现在需要打开自定义SMTP的开关才能用随便的邮箱去注册用户了。在设置-Authentication里面。这个表单输入的信息要是真实的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926172620751.png" srcset="/img/loading.gif" lazyload alt="image-20240926172620751"></p>
<p>否则就会报错：Error: Email address “<a href="mailto:&#50;&#x37;&#x36;&#56;&#x32;&#x36;&#x30;&#x37;&#x35;&#52;&#x40;&#114;&#x72;&#46;&#x63;&#111;&#x6d;">&#50;&#x37;&#x36;&#56;&#x32;&#x36;&#x30;&#x37;&#x35;&#52;&#x40;&#114;&#x72;&#46;&#x63;&#111;&#x6d;</a>“ cannot be used as it is not authorized    at Object.signup [as mutationFn] </p>
<p>但是这还没有结束，下一小节是如何实现邮箱验证。supabase你关闭SMTP发送的功能好巧不巧，我现在要用到。。。💔</p>
<h5 id="1、apiAuth-1"><a href="#1、apiAuth-1" class="headerlink" title="1、apiAuth"></a>1、apiAuth</h5><p>传递给signUp的object中可以包含一个可选项，因为只有email和password是必需项，所以名字可以通过这样的方式传递进去，同时可以再传一个用户的头像。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">signup</span>(<span class="hljs-params">&#123; fullName, email, password &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; data, error &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">signUp</span>(&#123;<br>    email,<br>    password,<br>    <span class="hljs-attr">options</span>: &#123; <span class="hljs-attr">data</span>: &#123; fullName, <span class="hljs-attr">avatar</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125; &#125;,<br>  &#125;);<br>  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error.<span class="hljs-property">message</span>);<br>  <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="2、useSignUp"><a href="#2、useSignUp" class="headerlink" title="2、useSignUp"></a>2、useSignUp</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useMutation, useQueryClient &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@tanstack/react-query&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; signup <span class="hljs-keyword">as</span> signupApi &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../services/apiAuth&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useNavigate &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><span class="hljs-keyword">import</span> toast <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-hot-toast&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useSignup</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> queryClient = <span class="hljs-title function_">useQueryClient</span>();<br>  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();<br><br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">mutate</span>: signup, isLoading &#125; = <span class="hljs-title function_">useMutation</span>(&#123;<br>    <span class="hljs-attr">mutationFn</span>: signupApi,<br>    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> &#123;<br>      toast.<span class="hljs-title function_">success</span>(<br>        <span class="hljs-string">&quot;Account successfully created!Please verify the new account from the user&#x27;s email address&quot;</span><br>      );<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user);<br>    &#125;,<br>    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);<br>      toast.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>);<br>    &#125;,<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> &#123; signup, isLoading &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="3、onSubmit"><a href="#3、onSubmit" class="headerlink" title="3、onSubmit"></a>3、onSubmit</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params">&#123; fullName, email, password &#125;</span>) &#123;<br>  <span class="hljs-title function_">signup</span>(&#123; fullName, email, password &#125;, &#123; <span class="hljs-attr">onSettled</span>: reset &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里reset会引发问题。jonas还没改。</p>
<h5 id="4、其他"><a href="#4、其他" class="headerlink" title="4、其他"></a>4、其他</h5><ul>
<li>在Authentication-URL Configuration中的两个URL栏，分别填入了</li>
</ul>
<p>(<a target="_blank" rel="noopener" href="http://localhost:5173/dashboard">http://localhost:5173/dashboard</a>)   和（<a href="http://localhost:5173）我不知道是干嘛用的">http://localhost:5173）我不知道是干嘛用的</a></p>
<ul>
<li><p>“Temp Mail”（临时邮件）是指一种可以临时使用的电子邮件服务，允许用户生成一个临时的电子邮件地址。用户可以使用这个地址接收邮件，而不需要使用自己的真实邮箱。</p>
<p>地址：<a target="_blank" rel="noopener" href="https://temp-mail.org/en/">https://temp-mail.org/en/</a>          界面：（上面生成邮箱，下面是收件箱）</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926192815075.png" srcset="/img/loading.gif" lazyload alt="image-20240926192815075"></p>
<p>由于我们打开了SMTP的验证要求，所以用户在注册后都会在邮箱中收到一封需要验证的邮件，否则还是不能用这个邮箱登陆。</p>
<h4 id="（3）如何配置Gmail解决supabase停止发送邮件"><a href="#（3）如何配置Gmail解决supabase停止发送邮件" class="headerlink" title="（3）如何配置Gmail解决supabase停止发送邮件"></a>（3）如何配置Gmail解决supabase停止发送邮件</h4><p>这里是这个紧急变革的讨论区<a target="_blank" rel="noopener" href="https://github.com/orgs/supabase/discussions/29370">https://github.com/orgs/supabase/discussions/29370</a></p>
<p>咱们也是跟supabase的维护者对上话了😂能写进简历里吗</p>
<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927091045026.png" srcset="/img/loading.gif" lazyload alt="image-20240927091045026" style="zoom:80%;" />

<p>一开始我以为只有那些专门的邮箱发送服务商才可以，于是打算使用看起来很靠谱的Resend，但是由于它需要自己有个域名，甚至去华为买了一个（首年1元的）域名。。。</p>
<p>但是后来发现Gmail居然也可以？！</p>
<h5 id="1、设置自定义SMTP"><a href="#1、设置自定义SMTP" class="headerlink" title="1、设置自定义SMTP"></a>1、设置自定义SMTP</h5><p>在supabase的设置中找到Auth，下滑找到这个地方，首先点击<em>here</em>，进入设置邮箱limit的地方，把第一条设置改成3以上（每小时能够发的邮件数）。下面的email和name就相应填，email一定要填gmail邮箱，name可以随意。</p>
<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-09-27%20090706.png" srcset="/img/loading.gif" lazyload alt="img" style="zoom: 50%;" />

<p>下面的HOST和POST number就是smtp.gmail.com和465.</p>
<p><strong>Username需要再填一次邮箱地址，不是随便填的！！！！！！！！！！</strong></p>
<p><strong>密码也不是Gmail的登陆密码</strong>，而是需要专门的密码，在Gmail账户中打开两步验证后找到设置应用专用密码，然后生成一个，注意<strong>生成后只会出现一次</strong>，需要立马复制下来。</p>
<p>这里每次更改密码再回来会发现没有改变，这也是我去问supabase维护者的问题，但是其实没有影响的。</p>
<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927092904298.png" srcset="/img/loading.gif" lazyload alt="image-20240927092904298" style="zoom:50%;" />



<h5 id="2、如果遇到问题怎么获得详细的错误原因？"><a href="#2、如果遇到问题怎么获得详细的错误原因？" class="headerlink" title="2、如果遇到问题怎么获得详细的错误原因？"></a>2、如果遇到问题怎么获得详细的错误原因？</h5><p>在我们supabase的项目sidebar中有一个是<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927093243940.png" srcset="/img/loading.gif" lazyload alt="image-20240927093243940"></p>
<p>在里面可以找到关于Auth的所有日志，比如当SMTP没设置好就是这个错误：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927093406787.png" srcset="/img/loading.gif" lazyload alt="image-20240927093406787"></p>
<p>点进去会有详细的信息。</p>
<h5 id="3、成功！🥳"><a href="#3、成功！🥳" class="headerlink" title="3、成功！🥳"></a>3、成功！🥳</h5><p>经过一番不懈的努力，我终于实现了邮箱验证的功能，为了确认真的可以收到邮件，我使用了Temp emial的随机地址<a href="mailto:&#119;&#x61;&#109;&#97;&#99;&#x65;&#120;&#55;&#55;&#x35;&#x40;&#101;&#x78;&#119;&#x65;&#x6d;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">&#119;&#x61;&#109;&#97;&#99;&#x65;&#120;&#55;&#55;&#x35;&#x40;&#101;&#x78;&#119;&#x65;&#x6d;&#x65;&#x2e;&#x63;&#x6f;&#x6d;</a>（但是只要你不更换，每次进去都会是这个地址，所以很方便），并且在收件箱中真的看见了邮件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-09-27%20092114.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="（4）确保安全性"><a href="#（4）确保安全性" class="headerlink" title="（4）确保安全性"></a>（4）确保安全性</h4><p>修改Policy，否则未登录的用户也是可以访问到这些数据库的信息的。</p>
<h3 id="三、构建Header"><a href="#三、构建Header" class="headerlink" title="三、构建Header"></a>三、构建Header</h3><p>这是现在的Header：<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927093914593.png" srcset="/img/loading.gif" lazyload alt="image-20240927093914593"></p>
<p>我们在注册用户的函数中，上传了除开email和密码的可选项，其中包含了avatar。这些信息可以在React Query工具里看到。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240926224628775.png" srcset="/img/loading.gif" lazyload alt="image-20240926224628775"></p>
<p>我们的Header包含头像、还有两个图标。其中UserAvatar.jsx：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserAvatar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useUser</span>();<br>  <span class="hljs-keyword">const</span> &#123; fullName, avatar &#125; = user.<span class="hljs-property">user_metadata</span>;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">StyledUserAvatar</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;avatar</span> || &#x27;<span class="hljs-attr">default-user.jpg</span>&#x27;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;</span>`<span class="hljs-attr">Avatar</span> <span class="hljs-attr">of</span> $&#123;<span class="hljs-attr">fullName</span>&#125;`&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;fullName&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">StyledUserAvatar</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="四、实现更改密码和头像"><a href="#四、实现更改密码和头像" class="headerlink" title="四、实现更改密码和头像"></a>四、实现更改密码和头像</h3><h4 id="（1）准备工作"><a href="#（1）准备工作" class="headerlink" title="（1）准备工作"></a>（1）准备工作</h4><h5 id="1、在storage中建立自己的头像库，命名为avatars"><a href="#1、在storage中建立自己的头像库，命名为avatars" class="headerlink" title="1、在storage中建立自己的头像库，命名为avatars"></a>1、在storage中建立自己的头像库，命名为avatars</h5><h5 id="2、添加Policy"><a href="#2、添加Policy" class="headerlink" title="2、添加Policy"></a>2、添加Policy</h5><p>选择这一条，然后为auth用户添加所有的操作权限</p>
<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927100812071.png" srcset="/img/loading.gif" lazyload alt="image-20240927100812071" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927100757718.png" srcset="/img/loading.gif" lazyload alt="image-20240927100757718" style="zoom: 50%;" />

<h5 id="3、得到avatars中图片的URL路径"><a href="#3、得到avatars中图片的URL路径" class="headerlink" title="3、得到avatars中图片的URL路径"></a>3、得到avatars中图片的URL路径</h5><p>随便在其中上传一张图片，点击get url得到其URL路径，在后续的apiAuth中修改avatar的函数中需要用到。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927101356754.png" srcset="/img/loading.gif" lazyload alt="image-20240927101356754"></p>
<h4 id="（2）建立更新用户信息的函数"><a href="#（2）建立更新用户信息的函数" class="headerlink" title="（2）建立更新用户信息的函数"></a>（2）建立更新用户信息的函数</h4><h5 id="1、函数参数"><a href="#1、函数参数" class="headerlink" title="1、函数参数"></a>1、函数参数</h5><p>函数updateCurrentUser接收一个object，包含密码、全名和头像。</p>
<p><code>export async function updateCurrentUser(&#123; password, fullName, avatar &#125;)</code></p>
<h5 id="2、更新password或fullName"><a href="#2、更新password或fullName" class="headerlink" title="2、更新password或fullName"></a>2、更新password或fullName</h5><p>之所以可以把更新这些信息的函数笼统地弄成一个，是因为修改密码和修改全名并不在一个表格中，所以可以条件性地得到updateData。记住fullName和avatar在注册的时候就是通过options中的data关键字注册的，在传递要更新的内容的时候，也要把它们包裹在一个对象中传递。</p>
<p>在没有上传avatar的时候，就可以结束了，因为下面是有关更新avatar的内容。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">//更新密码或者全名</span><br><span class="hljs-keyword">let</span> updateData;<br><span class="hljs-keyword">if</span> (password) updateData = &#123; password &#125;;<br><span class="hljs-keyword">if</span> (fullName) updateData = &#123; <span class="hljs-attr">data</span>: &#123; fullName &#125; &#125;;<br><br><span class="hljs-keyword">const</span> &#123; data, error &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">updateUser</span>(updateData);<br><br><span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error.<span class="hljs-property">message</span>);<br><span class="hljs-keyword">if</span> (!avatar) <span class="hljs-keyword">return</span> data;<br></code></pre></td></tr></table></figure>

<h5 id="3、上传avatar"><a href="#3、上传avatar" class="headerlink" title="3、上传avatar"></a>3、上传avatar</h5><p>自定义filename，使用上面的操作返回的用户信息可以得到用户id，使用random()函数连接，放置图像名字重复。此处不需要返回data,这里是直接把图像上传到avatars库中。下面好更新。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> fileName = <span class="hljs-string">`avatar-<span class="hljs-subst">$&#123;data.user.id&#125;</span>-<span class="hljs-subst">$&#123;<span class="hljs-built_in">Math</span>.random()&#125;</span>`</span>;<br><br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">error</span>: storageError &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">storage</span><br>    .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;avatars&#x27;</span>)<br>    .<span class="hljs-title function_">upload</span>(fileName, avatar);<br><br>  <span class="hljs-keyword">if</span> (storageError) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(storageError.<span class="hljs-property">message</span>);<br></code></pre></td></tr></table></figure>

<h5 id="4、在用户信息中更新avatar"><a href="#4、在用户信息中更新avatar" class="headerlink" title="4、在用户信息中更新avatar"></a>4、在用户信息中更新avatar</h5><p>得到上面的URL中，把相应信息做一个替换，就可以更新了。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx">  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: updatedUser, <span class="hljs-attr">error</span>: error2 &#125; = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">updateUser</span>(&#123;<br>    <span class="hljs-attr">data</span>: &#123;<br>      <span class="hljs-attr">avatar</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;supabaseUrl&#125;</span>/storage/v1/object/public/avatars/<span class="hljs-subst">$&#123;fileName&#125;</span>`</span>,<br>    &#125;,<br>  &#125;);<br><br>  <span class="hljs-keyword">if</span> (error2) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error2.<span class="hljs-property">message</span>);<br><br>  <span class="hljs-keyword">return</span> updatedUser;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="（3）useUpdate"><a href="#（3）useUpdate" class="headerlink" title="（3）useUpdate"></a>（3）useUpdate</h4><p>onSuccess中，<code>queryClient.setQueryData([&#39;user&#39;], user);</code><strong>查询参数必须是字符串</strong>，否则就会报下图的错误。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUpdateUser</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> queryClient = <span class="hljs-title function_">useQueryClient</span>();<br><br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">mutate</span>: updateUser, <span class="hljs-attr">isLoading</span>: isUpdating &#125; = <span class="hljs-title function_">useMutation</span>(&#123;<br>    <span class="hljs-attr">mutationFn</span>: updateCurrentUser,<br>    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">&#123;user&#125;</span>) =&gt;</span> &#123;<br>      toast.<span class="hljs-title function_">success</span>(<span class="hljs-string">&#x27;User account successfully updated&#x27;</span>);<br>      queryClient.<span class="hljs-title function_">setQueryData</span>([<span class="hljs-string">&#x27;user&#x27;</span>], user);<br>      queryClient.<span class="hljs-title function_">invalidateQueries</span>(&#123;<br>        <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;user&#x27;</span>],<br>      &#125;);<br>    &#125;,<br>    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> toast.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>),<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> &#123; isUpdating, updateUser &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Yaodeer/pict@main/image-20240927105001683.png" srcset="/img/loading.gif" lazyload alt="image-20240927105001683"></p>
<p>原因是：</p>
<ul>
<li><strong>数据结构</strong>：React Query 在内部维护查询缓存时，期望查询键（比如 <code>[&#39;user&#39;]</code>）是一个数组，因为数组可以包含多个层次的键名和参数。直接使用字符串 <code>&#39;user&#39;</code> 会导致它无法正确处理查询数据的结构。</li>
<li><strong>查询数据格式</strong>：当你使用 <code>queryClient.setQueryData</code> 设置数据时，它希望能在内部维护一个对象结构。如果你只传递了一个字符串，它无法创建或修改必要的内部属性。</li>
</ul>
<h3 id="？-涉及到的知识点详细分析（COPY）"><a href="#？-涉及到的知识点详细分析（COPY）" class="headerlink" title="？.涉及到的知识点详细分析（COPY）"></a>？.涉及到的知识点详细分析（COPY）</h3><h4 id="（1）session（会话）"><a href="#（1）session（会话）" class="headerlink" title="（1）session（会话）"></a>（1）session（会话）</h4><p><strong>会话</strong>是用户与系统之间的持续交互状态，它保存用户的身份和状态信息，以便在多次请求中维持用户的登录状态和操作权限。在你提供的代码中，<code>session</code> 是 Supabase 通过 JWT 来管理的会话，它记录了用户的登录状态，并用来确定用户是否有权限访问某些资源。</p>
<h5 id="1-会话的定义："><a href="#1-会话的定义：" class="headerlink" title="1. 会话的定义："></a>1. <strong>会话的定义</strong>：</h5><ul>
<li>会话是用户在一段时间内与应用程序或服务器之间进行的交互过程。它可以持续几秒钟到数小时，甚至更久，取决于会话的管理方式和应用程序的配置。</li>
<li>会话通常在用户登录或访问某个系统时开始，并在用户注销或超时后结束。</li>
</ul>
<h5 id="2-会话的作用："><a href="#2-会话的作用：" class="headerlink" title="2. 会话的作用："></a>2. <strong>会话的作用</strong>：</h5><ul>
<li><strong>维持用户的身份验证状态</strong>：会话允许系统在多次请求之间记住用户的身份。例如，用户登录后，会话用于保存登录状态，以免用户每次访问页面时都需要重新登录。</li>
<li><strong>存储用户的临时信息</strong>：会话可以用来在不同页面间共享用户的临时数据，例如购物车信息、用户首选项等。</li>
<li><strong>确保安全性</strong>：通过会话，系统可以跟踪和验证用户的操作，防止未经授权的访问。</li>
</ul>
<h5 id="3-会话是如何工作的："><a href="#3-会话是如何工作的：" class="headerlink" title="3. 会话是如何工作的："></a>3. <strong>会话是如何工作的</strong>：</h5><ul>
<li>当用户登录系统时，服务器会为该用户创建一个唯一的会话 ID，并将会话信息（如用户身份、权限等）与该会话 ID 关联。</li>
<li>会话 ID 通常通过 <strong>Cookies</strong>、<strong>Token</strong>（例如 JWT，JSON Web Token），或其他机制（如 URL 参数）存储在客户端。</li>
<li>在每次用户发送请求时，客户端会将会话 ID 传递给服务器，服务器根据这个 ID 查找与之关联的会话数据，确认用户的身份和权限。</li>
</ul>
<h5 id="4-会话的生命周期："><a href="#4-会话的生命周期：" class="headerlink" title="4. 会话的生命周期："></a>4. <strong>会话的生命周期</strong>：</h5><ul>
<li><strong>创建</strong>：会话通常在用户成功登录后由服务器创建，分配一个唯一的会话 ID。</li>
<li><strong>维持</strong>：在会话存续期间，用户的每次请求都使用同一会话 ID，服务器根据这个 ID 确认用户身份。</li>
<li><strong>销毁</strong>：会话可以通过用户主动注销、会话超时（例如长时间不活动）或服务器强制结束而销毁。当会话销毁后，用户需要重新登录以继续访问系统。</li>
</ul>
<h5 id="5-会话在前端和后端的角色："><a href="#5-会话在前端和后端的角色：" class="headerlink" title="5. 会话在前端和后端的角色："></a>5. <strong>会话在前端和后端的角色</strong>：</h5><ul>
<li><strong>前端</strong>：前端通过 Cookies 或 Local Storage 来存储会话 ID 或 Token。在每次向服务器发出请求时，前端会自动携带这些凭据来验证用户身份。</li>
<li><strong>后端</strong>：后端负责生成和管理会话，保存会话相关的用户状态、信息，并在每次请求时验证用户的会话是否有效。</li>
</ul>
<h5 id="6-会话与-Token（如-JWT）的关系："><a href="#6-会话与-Token（如-JWT）的关系：" class="headerlink" title="6. 会话与 Token（如 JWT）的关系："></a>6. <strong>会话与 Token（如 JWT）的关系</strong>：</h5><ul>
<li><strong>传统会话</strong>：会话 ID 由服务器生成，并且服务器需要存储会话信息。这种方式通常需要维护一个会话存储，适用于基于服务器的应用程序。</li>
<li><strong>Token（如 JWT）</strong>：JWT 是一种常用的无状态会话机制，其中用户的身份信息通过加密后保存在 Token 中。服务器不需要存储会话信息，而是通过验证和解码 Token 来识别用户。</li>
</ul>
<h5 id="7-Supabase-中的会话："><a href="#7-Supabase-中的会话：" class="headerlink" title="7. Supabase 中的会话："></a>7. <strong>Supabase 中的会话</strong>：</h5><p>在你使用的 <code>Supabase</code> 中，会话是通过 <strong>JWT（JSON Web Token）</strong> 进行管理的。当用户登录时，<code>Supabase</code> 会生成一个 JWT，并将其保存在客户端。每次请求都会带上这个 Token，以证明用户的身份。</p>
<ul>
<li><code>supabase.auth.getSession()</code>：该方法用于获取当前会话信息（包括 JWT）。如果用户当前登录了，这个会话就会返回有效的 JWT。</li>
<li><code>supabase.auth.getUser()</code>：在有有效会话时，使用该方法获取当前会话中的用户详细信息。</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/react%E8%AF%BE%E7%A8%8B/" class="category-chain-item">react课程</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/react/" class="print-no-link">#react</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>react课程22-实现较为完整的用户管理功能</div>
      <div>http://example.com/2024/09/26/react课程22-实现较为完整的用户管理功能/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Yaodeer</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>September 26, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/09/27/react%E8%AF%BE%E7%A8%8B23-%E9%A1%B9%E7%9B%AE%E6%94%B6%E5%B0%BE/" title="react课程23-项目收尾">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">react课程23-项目收尾</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/09/25/react%E8%AF%BE%E7%A8%8B21-%E5%AE%8C%E5%96%84table%E7%9A%84%E6%98%BE%E7%A4%BA%E5%8A%9F%E8%83%BD%E4%BB%A5%E5%8F%8Abooking%E7%9A%84%E7%8A%B6%E6%80%81%E6%9B%B4%E6%94%B9/" title="react课程21-完善table的显示功能以及booking的状态更改">
                        <span class="hidden-mobile">react课程21-完善table的显示功能以及booking的状态更改</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://cdn.staticfile.org/waline/2.15.5/waline.min.css')
      Fluid.utils.createScript('https://cdn.staticfile.org/waline/2.15.5/waline.min.js', function() {
        var options = Object.assign(
          {"serverURL":"https://comment-three-kappa.vercel.app","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":500,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>2024</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Yaodeer</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
